{"version":3,"names":["jsx","Editor","autop","createEditor","deserializeHTML","htmlString","normalize","deserialize","DOMParser","parseFromString","formatBeforeDeserializing","body","val","editor","children","force","value","$value","replace","el","TEXT_TAGS","EM","italic","I","STRONG","bold","ELEMENT_TAGS","P","type","MERGETAG","data","dataset","modifier","text","underline","A","url","getAttribute","nodeType","Node","TEXT_NODE","textContent","undefined","nodeName","parent","Array","from","childNodes","map","flat","descendants","length","attrs","child"],"sources":["@quillforms/admin-components/src/rich-text/html-deserialize.ts"],"sourcesContent":["/**\r\n * External Dependencies\r\n */\r\nimport { jsx } from 'slate-hyperscript';\r\nimport { Editor, Node as SlateNode, Descendant, Text } from 'slate';\r\nimport { autop } from '@wordpress/autop';\r\n\r\n/**\r\n * Internal Dependencies\r\n */\r\nimport createEditor from './create-editor';\r\nimport { MergeTag } from './types';\r\n\r\nconst deserializeHTML = ( htmlString: string ): SlateNode[] => {\r\n\treturn normalize(\r\n\t\tdeserialize(\r\n\t\t\tnew DOMParser().parseFromString(\r\n\t\t\t\tformatBeforeDeserializing( autop( htmlString ) ),\r\n\t\t\t\t'text/html'\r\n\t\t\t).body\r\n\t\t)\r\n\t);\r\n};\r\n\r\n// Normalize to fix invalid JSON that may result from deserializing\r\n// This custom normalizer should be called one time only after the component mounting\r\nconst normalize = ( val: SlateNode[] ): SlateNode[] => {\r\n\t// Create temp editor for normalizing\r\n\tconst editor = createEditor();\r\n\teditor.children = val;\r\n\tEditor.normalize( editor, { force: true } );\r\n\treturn editor.children;\r\n};\r\n\r\nconst formatBeforeDeserializing = ( value: string ): string => {\r\n\tif ( ! value ) {\r\n\t\treturn '<p></p>';\r\n\t}\r\n\tconst $value = value.replace(\r\n\t\t/{{([a-zA-Z0-9-_]+):([a-zA-Z0-9-_]+)}}/g,\r\n\t\t\"<mergetag data-type='$1' data-modifier='$2'>_____</mergetag>\"\r\n\t);\r\n\treturn $value;\r\n};\r\n\r\nconst deserialize = ( el: HTMLElement | ChildNode ) => {\r\n\tconst TEXT_TAGS = {\r\n\t\t// CODE: () => ({ code: true }),\r\n\t\t// DEL: () => ({ strikethrough: true }),\r\n\t\tEM: () => ( { italic: true } ),\r\n\t\tI: () => ( { italic: true } ),\r\n\t\t// S: () => ({ strikethrough: true }),\r\n\t\tSTRONG: () => ( { bold: true } ),\r\n\t};\r\n\tconst ELEMENT_TAGS = {\r\n\t\tP: () => ( { type: 'paragraph' } ),\r\n\t\tMERGETAG: () => ( {\r\n\t\t\ttype: 'mergeTag',\r\n\t\t\tdata: {\r\n\t\t\t\ttype: ( ( el as HTMLElement ).dataset as MergeTag ).type,\r\n\t\t\t\tmodifier: ( ( el as HTMLElement ).dataset as MergeTag )\r\n\t\t\t\t\t.modifier,\r\n\t\t\t},\r\n\t\t\tchildren: [\r\n\t\t\t\t{\r\n\t\t\t\t\ttext: '',\r\n\t\t\t\t\tbold: false,\r\n\t\t\t\t\titalic: false,\r\n\t\t\t\t\tunderline: false,\r\n\t\t\t\t},\r\n\t\t\t],\r\n\t\t} ),\r\n\t\tA: () => ( {\r\n\t\t\ttype: 'link',\r\n\t\t\turl: ( el as HTMLElement ).getAttribute( 'href' ),\r\n\t\t} ),\r\n\r\n\t\t// H1: () => ({ type: \"heading-one\" }),\r\n\t\t// H2: () => ({ type: \"heading-two\" }),\r\n\t\t// BLOCKQUOTE: () => ({ type: \"quote\" }),\r\n\t\t// LI: () => ({ type: \"list-item\" }),\r\n\t\t// OL: () => ({ type: \"numbered-list\" }),\r\n\t\t// UL: () => ({ type: \"bulleted-list\" }),\r\n\t\t// IMG: el => ({ type: \"image\", url: el.getAttribute(\"src\") })\r\n\t};\r\n\r\n\tif ( el.nodeType === Node.TEXT_NODE ) {\r\n\t\tif ( el.textContent !== '\\n' ) {\r\n\t\t\treturn el.textContent;\r\n\t\t}\r\n\t}\r\n\tif ( el.nodeType !== 1 ) {\r\n\t\treturn undefined;\r\n\t}\r\n\tif ( el.nodeName === 'BR' ) {\r\n\t\treturn '\\n';\r\n\t}\r\n\r\n\tconst { nodeName } = el;\r\n\tlet parent = el;\r\n\r\n\t// if (\r\n\t// \tnodeName === 'PRE' &&\r\n\t// \tel.childNodes[ 0 ] &&\r\n\t// \tel.childNodes[ 0 ].nodeName === 'CODE'\r\n\t// ) {\r\n\t// \t[ parent ] = el.childNodes;\r\n\t// }\r\n\r\n\tconst children = Array.from( parent.childNodes ).map( deserialize ).flat();\r\n\r\n\tlet descendants = children as Descendant[];\r\n\tif ( ! descendants.length ) {\r\n\t\tdescendants = [ { text: '' } ];\r\n\t}\r\n\r\n\tif ( el.nodeName === 'BODY' ) {\r\n\t\treturn jsx( 'fragment', descendants );\r\n\t}\r\n\r\n\tif ( ELEMENT_TAGS[ nodeName ] ) {\r\n\t\tconst attrs = ELEMENT_TAGS[ nodeName ]( el );\r\n\r\n\t\treturn jsx( 'element', { ...attrs }, descendants );\r\n\t}\r\n\r\n\tif ( TEXT_TAGS[ nodeName ] ) {\r\n\t\tconst attrs = TEXT_TAGS[ nodeName ]( el );\r\n\t\treturn children.map( ( child: Descendant ): void | Text => {\r\n\t\t\t// This condition is to prevent throwing error when we have a string like this: <strong> {{type:modifier}} </strong>\r\n\t\t\tif ( child.type !== 'mergeTag' ) {\r\n\t\t\t\treturn jsx( 'text', { ...attrs }, child );\r\n\t\t\t}\r\n\t\t} );\r\n\t}\r\n\r\n\treturn children;\r\n};\r\n\r\nexport default deserializeHTML;\r\n"],"mappings":"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"}