{"version":3,"names":["useMemo","useCallback","useEffect","useState","useRef","Fragment","autop","plusCircle","Icon","debounce","classnames","Transforms","ReactEditor","createEditor","deserialize","serialize","RichTextEditor","RichTextControlRenderer","_ref","id","value","setValue","mergeTags","className","allowedFormats","focusOnMount","placeholder","isReady","setIsReady","jsonVal","setJsonVal","type","children","text","currentSelection","setCurrentSelection","path","offset","editor","isMounted","current","serializeVal","newVal","onChange","selection","focus","setTimeout","length","TextEditor","createElement","onFocus","JSON","stringify","icon","onClick","e","stopPropagation","insertText","at","select","move","unit"],"sources":["@quillforms/admin-components/src/rich-text/components/richtext-control/renderer.tsx"],"sourcesContent":["/**\r\n * WordPress Dependencies\r\n */\r\nimport {\r\n\tuseMemo,\r\n\tuseCallback,\r\n\tuseEffect,\r\n\tuseState,\r\n\tuseRef,\r\n\tFragment,\r\n} from 'react';\r\nimport { autop } from '@wordpress/autop';\r\nimport { plusCircle } from '@wordpress/icons';\r\nimport { Icon } from '@wordpress/components';\r\n\r\n/**\r\n * External Dependencies\r\n */\r\nimport { debounce } from 'lodash';\r\nimport classnames from 'classnames';\r\nimport { Transforms, Node } from 'slate';\r\nimport { HistoryEditor } from 'slate-history';\r\nimport { ReactEditor } from 'slate-react';\r\n\r\n/**\r\n * Internal Dependencies\r\n */\r\nimport createEditor from '../../create-editor';\r\nimport deserialize from '../../html-deserialize';\r\nimport serialize from '../../html-serialize';\r\nimport RichTextEditor from '../editor';\r\nimport { allowedFormats, CustomNode, MergeTags } from '../../types';\r\n\r\ninterface Props {\r\n\tvalue: string;\r\n\tid?: string;\r\n\tsetValue: ( value: string ) => void;\r\n\tmergeTags?: MergeTags;\r\n\tclassName?: string;\r\n\tallowedFormats?: allowedFormats;\r\n\tfocusOnMount?: boolean;\r\n\tplaceholder?: string;\r\n}\r\nconst RichTextControlRenderer: React.FC< Props > = ( {\r\n\tid,\r\n\tvalue,\r\n\tsetValue,\r\n\tmergeTags,\r\n\tclassName,\r\n\tallowedFormats,\r\n\tfocusOnMount = false,\r\n\tplaceholder,\r\n} ) => {\r\n\tconst [ isReady, setIsReady ] = useState( false );\r\n\tconst [ jsonVal, setJsonVal ] = useState< CustomNode[] >( [\r\n\t\t{\r\n\t\t\ttype: 'paragraph',\r\n\t\t\tchildren: [\r\n\t\t\t\t{\r\n\t\t\t\t\ttext: '',\r\n\t\t\t\t},\r\n\t\t\t],\r\n\t\t},\r\n\t] );\r\n\r\n\tconst [ currentSelection, setCurrentSelection ] = useState( {\r\n\t\tpath: [ 0, 0 ],\r\n\t\toffset: 0,\r\n\t} );\r\n\r\n\tconst editor: ReactEditor & HistoryEditor = useMemo(\r\n\t\t() => createEditor(),\r\n\t\t[ id, isReady ]\r\n\t);\r\n\r\n\tconst isMounted = useRef( false );\r\n\tuseEffect( () => {\r\n\t\tisMounted.current = true;\r\n\t\treturn () => {\r\n\t\t\tisMounted.current = false;\r\n\t\t};\r\n\t}, [] );\r\n\r\n\t// serializeVal is a debounced function that updates the store with serialized html value\r\n\tconst serializeVal = useCallback(\r\n\t\tdebounce( ( newVal ) => {\r\n\t\t\tif ( isMounted.current ) {\r\n\t\t\t\tsetValue( serialize( newVal ) );\r\n\t\t\t}\r\n\t\t}, 200 ),\r\n\t\t[]\r\n\t);\r\n\r\n\tconst onChange = ( newVal: Node[] ) => {\r\n\t\tif ( editor.selection ) {\r\n\t\t\tsetCurrentSelection( {\r\n\t\t\t\tpath: editor.selection.focus.path,\r\n\t\t\t\toffset: editor.selection.focus.offset,\r\n\t\t\t} );\r\n\t\t}\r\n\t\tsetJsonVal( newVal );\r\n\t\tserializeVal( newVal );\r\n\t};\r\n\r\n\t// Deserialize value on mount.\r\n\tuseEffect( () => {\r\n\t\tif ( focusOnMount ) {\r\n\t\t\tsetTimeout( () => {\r\n\t\t\t\tReactEditor.focus( editor );\r\n\t\t\t}, 0 );\r\n\t\t}\r\n\t}, [] );\r\n\r\n\tuseEffect( () => {\r\n\t\tsetIsReady( false );\r\n\t\tsetJsonVal( deserialize( autop( value ) ) );\r\n\t\tsetIsReady( true );\r\n\t}, [ mergeTags?.length ] );\r\n\r\n\tconst TextEditor = useMemo(\r\n\t\t() => (\r\n\t\t\t<RichTextEditor\r\n\t\t\t\tvalue={ jsonVal }\r\n\t\t\t\teditor={ editor }\r\n\t\t\t\tonChange={ onChange }\r\n\t\t\t\tmergeTags={ mergeTags }\r\n\t\t\t\tonFocus={ () => {\r\n\t\t\t\t\tif ( editor.selection ) {\r\n\t\t\t\t\t\tsetCurrentSelection( {\r\n\t\t\t\t\t\t\tpath: editor.selection.focus.path,\r\n\t\t\t\t\t\t\toffset: editor.selection.focus.offset,\r\n\t\t\t\t\t\t} );\r\n\t\t\t\t\t}\r\n\t\t\t\t} }\r\n\t\t\t\tallowedFormats={ allowedFormats }\r\n\t\t\t\tplaceholder={ placeholder }\r\n\t\t\t/>\r\n\t\t),\r\n\t\t[ isReady, JSON.stringify( jsonVal ), JSON.stringify( mergeTags ) ]\r\n\t);\r\n\r\n\tif ( ! isReady ) return null;\r\n\r\n\treturn (\r\n\t\t<div className={ classnames( 'rich-text-control', className ) }>\r\n\t\t\t<Fragment>\r\n\t\t\t\t{ TextEditor }\r\n\t\t\t\t{ mergeTags && mergeTags.length > 0 && (\r\n\t\t\t\t\t<Fragment>\r\n\t\t\t\t\t\t<div className=\"rich-text-control__add-merge-tags\">\r\n\t\t\t\t\t\t\t<Icon\r\n\t\t\t\t\t\t\t\ticon={ plusCircle }\r\n\t\t\t\t\t\t\t\t// @ts-expect-error\r\n\t\t\t\t\t\t\t\tonClick={ ( e: MouseEvent ) => {\r\n\t\t\t\t\t\t\t\t\te.stopPropagation();\r\n\r\n\t\t\t\t\t\t\t\t\tTransforms.insertText( editor, '@', {\r\n\t\t\t\t\t\t\t\t\t\tat: currentSelection,\r\n\t\t\t\t\t\t\t\t\t} );\r\n\t\t\t\t\t\t\t\t\tsetTimeout( () => {\r\n\t\t\t\t\t\t\t\t\t\tTransforms.select(\r\n\t\t\t\t\t\t\t\t\t\t\teditor,\r\n\t\t\t\t\t\t\t\t\t\t\tcurrentSelection\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t\tReactEditor.focus( editor );\r\n\t\t\t\t\t\t\t\t\t\tTransforms.move( editor, {\r\n\t\t\t\t\t\t\t\t\t\t\tunit: 'character',\r\n\t\t\t\t\t\t\t\t\t\t} );\r\n\t\t\t\t\t\t\t\t\t}, 0 );\r\n\t\t\t\t\t\t\t\t} }\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</Fragment>\r\n\t\t\t\t) }\r\n\t\t\t</Fragment>\r\n\t\t</div>\r\n\t);\r\n};\r\nexport default RichTextControlRenderer;\r\n"],"mappings":"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"}