{"version":3,"names":["_react","require","_autop","_icons","_components","_lodash","_classnames","_interopRequireDefault","_slate","_slateReact","_createEditor","_htmlDeserialize","_htmlSerialize","_editor","RichTextControlRenderer","_ref","id","value","setValue","mergeTags","className","allowedFormats","focusOnMount","placeholder","isReady","setIsReady","useState","jsonVal","setJsonVal","type","children","text","currentSelection","setCurrentSelection","path","offset","editor","useMemo","createEditor","isMounted","useRef","useEffect","current","serializeVal","useCallback","debounce","newVal","serialize","onChange","selection","focus","setTimeout","ReactEditor","deserialize","autop","length","TextEditor","_element","createElement","default","onFocus","JSON","stringify","classnames","Fragment","Icon","icon","plusCircle","onClick","e","stopPropagation","Transforms","insertText","at","select","move","unit","_default","exports"],"sources":["@quillforms/admin-components/src/rich-text/components/richtext-control/renderer.tsx"],"sourcesContent":["/**\r\n * WordPress Dependencies\r\n */\r\nimport {\r\n\tuseMemo,\r\n\tuseCallback,\r\n\tuseEffect,\r\n\tuseState,\r\n\tuseRef,\r\n\tFragment,\r\n} from 'react';\r\nimport { autop } from '@wordpress/autop';\r\nimport { plusCircle } from '@wordpress/icons';\r\nimport { Icon } from '@wordpress/components';\r\n\r\n/**\r\n * External Dependencies\r\n */\r\nimport { debounce } from 'lodash';\r\nimport classnames from 'classnames';\r\nimport { Transforms, Node } from 'slate';\r\nimport { HistoryEditor } from 'slate-history';\r\nimport { ReactEditor } from 'slate-react';\r\n\r\n/**\r\n * Internal Dependencies\r\n */\r\nimport createEditor from '../../create-editor';\r\nimport deserialize from '../../html-deserialize';\r\nimport serialize from '../../html-serialize';\r\nimport RichTextEditor from '../editor';\r\nimport { allowedFormats, CustomNode, MergeTags } from '../../types';\r\n\r\ninterface Props {\r\n\tvalue: string;\r\n\tid?: string;\r\n\tsetValue: ( value: string ) => void;\r\n\tmergeTags?: MergeTags;\r\n\tclassName?: string;\r\n\tallowedFormats?: allowedFormats;\r\n\tfocusOnMount?: boolean;\r\n\tplaceholder?: string;\r\n}\r\nconst RichTextControlRenderer: React.FC< Props > = ( {\r\n\tid,\r\n\tvalue,\r\n\tsetValue,\r\n\tmergeTags,\r\n\tclassName,\r\n\tallowedFormats,\r\n\tfocusOnMount = false,\r\n\tplaceholder,\r\n} ) => {\r\n\tconst [ isReady, setIsReady ] = useState( false );\r\n\tconst [ jsonVal, setJsonVal ] = useState< CustomNode[] >( [\r\n\t\t{\r\n\t\t\ttype: 'paragraph',\r\n\t\t\tchildren: [\r\n\t\t\t\t{\r\n\t\t\t\t\ttext: '',\r\n\t\t\t\t},\r\n\t\t\t],\r\n\t\t},\r\n\t] );\r\n\r\n\tconst [ currentSelection, setCurrentSelection ] = useState( {\r\n\t\tpath: [ 0, 0 ],\r\n\t\toffset: 0,\r\n\t} );\r\n\r\n\tconst editor: ReactEditor & HistoryEditor = useMemo(\r\n\t\t() => createEditor(),\r\n\t\t[ id, isReady ]\r\n\t);\r\n\r\n\tconst isMounted = useRef( false );\r\n\tuseEffect( () => {\r\n\t\tisMounted.current = true;\r\n\t\treturn () => {\r\n\t\t\tisMounted.current = false;\r\n\t\t};\r\n\t}, [] );\r\n\r\n\t// serializeVal is a debounced function that updates the store with serialized html value\r\n\tconst serializeVal = useCallback(\r\n\t\tdebounce( ( newVal ) => {\r\n\t\t\tif ( isMounted.current ) {\r\n\t\t\t\tsetValue( serialize( newVal ) );\r\n\t\t\t}\r\n\t\t}, 200 ),\r\n\t\t[]\r\n\t);\r\n\r\n\tconst onChange = ( newVal: Node[] ) => {\r\n\t\tif ( editor.selection ) {\r\n\t\t\tsetCurrentSelection( {\r\n\t\t\t\tpath: editor.selection.focus.path,\r\n\t\t\t\toffset: editor.selection.focus.offset,\r\n\t\t\t} );\r\n\t\t}\r\n\t\tsetJsonVal( newVal );\r\n\t\tserializeVal( newVal );\r\n\t};\r\n\r\n\t// Deserialize value on mount.\r\n\tuseEffect( () => {\r\n\t\tif ( focusOnMount ) {\r\n\t\t\tsetTimeout( () => {\r\n\t\t\t\tReactEditor.focus( editor );\r\n\t\t\t}, 0 );\r\n\t\t}\r\n\t}, [] );\r\n\r\n\tuseEffect( () => {\r\n\t\tsetIsReady( false );\r\n\t\tsetJsonVal( deserialize( autop( value ) ) );\r\n\t\tsetIsReady( true );\r\n\t}, [ mergeTags?.length ] );\r\n\r\n\tconst TextEditor = useMemo(\r\n\t\t() => (\r\n\t\t\t<RichTextEditor\r\n\t\t\t\tvalue={ jsonVal }\r\n\t\t\t\teditor={ editor }\r\n\t\t\t\tonChange={ onChange }\r\n\t\t\t\tmergeTags={ mergeTags }\r\n\t\t\t\tonFocus={ () => {\r\n\t\t\t\t\tif ( editor.selection ) {\r\n\t\t\t\t\t\tsetCurrentSelection( {\r\n\t\t\t\t\t\t\tpath: editor.selection.focus.path,\r\n\t\t\t\t\t\t\toffset: editor.selection.focus.offset,\r\n\t\t\t\t\t\t} );\r\n\t\t\t\t\t}\r\n\t\t\t\t} }\r\n\t\t\t\tallowedFormats={ allowedFormats }\r\n\t\t\t\tplaceholder={ placeholder }\r\n\t\t\t/>\r\n\t\t),\r\n\t\t[ isReady, JSON.stringify( jsonVal ), JSON.stringify( mergeTags ) ]\r\n\t);\r\n\r\n\tif ( ! isReady ) return null;\r\n\r\n\treturn (\r\n\t\t<div className={ classnames( 'rich-text-control', className ) }>\r\n\t\t\t<Fragment>\r\n\t\t\t\t{ TextEditor }\r\n\t\t\t\t{ mergeTags && mergeTags.length > 0 && (\r\n\t\t\t\t\t<Fragment>\r\n\t\t\t\t\t\t<div className=\"rich-text-control__add-merge-tags\">\r\n\t\t\t\t\t\t\t<Icon\r\n\t\t\t\t\t\t\t\ticon={ plusCircle }\r\n\t\t\t\t\t\t\t\t// @ts-expect-error\r\n\t\t\t\t\t\t\t\tonClick={ ( e: MouseEvent ) => {\r\n\t\t\t\t\t\t\t\t\te.stopPropagation();\r\n\r\n\t\t\t\t\t\t\t\t\tTransforms.insertText( editor, '@', {\r\n\t\t\t\t\t\t\t\t\t\tat: currentSelection,\r\n\t\t\t\t\t\t\t\t\t} );\r\n\t\t\t\t\t\t\t\t\tsetTimeout( () => {\r\n\t\t\t\t\t\t\t\t\t\tTransforms.select(\r\n\t\t\t\t\t\t\t\t\t\t\teditor,\r\n\t\t\t\t\t\t\t\t\t\t\tcurrentSelection\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t\tReactEditor.focus( editor );\r\n\t\t\t\t\t\t\t\t\t\tTransforms.move( editor, {\r\n\t\t\t\t\t\t\t\t\t\t\tunit: 'character',\r\n\t\t\t\t\t\t\t\t\t\t} );\r\n\t\t\t\t\t\t\t\t\t}, 0 );\r\n\t\t\t\t\t\t\t\t} }\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</Fragment>\r\n\t\t\t\t) }\r\n\t\t\t</Fragment>\r\n\t\t</div>\r\n\t);\r\n};\r\nexport default RichTextControlRenderer;\r\n"],"mappings":"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"}